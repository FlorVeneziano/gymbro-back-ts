steps:
  - name: "gcr.io/cloud-builders/npm"
    args: ["install", "-g", "pnpm"]

  - name: "gcr.io/cloud-builders/npm"
    entrypoint: "pnpm"
    args: ["install"]

  - name: "gcr.io/cloud-builders/npm"
    entrypoint: "pnpm"
    args: ["run", "build"]

  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        gcloud secrets versions access latest --secret="DB_NAME" > /workspace/DB_NAME &&
        echo "DB_NAME=$(cat /workspace/DB_NAME)" >> .env &&
        gcloud secrets versions access latest --secret="DB_USER" > /workspace/DB_USER &&
        echo "DB_USER=$(cat /workspace/DB_USER)" >> .env &&
        gcloud secrets versions access latest --secret="DB_PASSWORD" > /workspace/DB_PASSWORD &&
        echo "DB_PASSWORD=$(cat /workspace/DB_PASSWORD)" >> .env &&
        gcloud secrets versions access latest --secret="DB_HOST" > /workspace/DB_HOST &&
        echo "DB_HOST=$(cat /workspace/DB_HOST)" >> .env &&
        gcloud secrets versions access latest --secret="DB_DIALECT" > /workspace/DB_DIALECT &&
        echo "DB_DIALECT=$(cat /workspace/DB_DIALECT)" >> .env &&
        gcloud secrets versions access latest --secret="SECRET_KEY" > /workspace/SECRET_KEY &&
        echo "SECRET_KEY=$(cat /workspace/SECRET_KEY)" >> .env &&
        gcloud run deploy gymbro-back-ts --image gcr.io/$PROJECT_ID/gymbro-back-ts --platform managed --region southamerica-east1 --set-env-vars PORT=8080

timeout: "1600s"

options:
  logging: CLOUD_LOGGING_ONLY
